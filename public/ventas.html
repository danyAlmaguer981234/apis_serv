<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.js"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.4.0/js/dataTables.select.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css" />
    <link href="https://cdn.datatables.net/select/1.4.0/css/select.dataTables.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script type="text/javascript">
        var arr1 = [];
        $(document).ajaxStart(function () {
            $('#loading').show();

        }).ajaxStop(function () {
            $('#loading').hide();
            $('#tableClient').DataTable({
                select: {
                    style: 'multi'
                }
            });



            $('#tableArt').DataTable($("#tableArt tr").click(function () {

                $("#tbName").val($(this).find("td").eq(2).html());
                $("#tbShortAlias").val($(this).find("td").eq(0).html())
                $("#tbLastName").val($(this).find("td").eq(3).html());
                $("#tbCliente").val($(this).find("td").eq(4).html());
                $("#tbUsrAlias").val($(this).find("td").eq(1).html());



            }));


        });

        $.ajax({
            type: "GET",
            url: "http://10.11.1.240:8000/api/getItems",
            async: true,
            dataType: "json",
            success: function (response) {
                console.log(response);
            },
        }).done(
            function (data, textStatus, jqXHR) {
                $('#tableClient').show();
                var str = '';
                for (var i = 0; i < data.length; i++) {

                    str += '<tr>' +
                        '<td>' + data[i].pt_part + '</td>' +
                        '<td>' + data[i].pt_desc1 + data[i].pt_desc2 + '</td>' +
                        '<td>' + data[i].pt_um + '</td>' +
                        '<td>' + data[i].pid_amt + '</td>' +
                        '<td>' + '<input type="text" class="form-control" name="tbCant" placeholder="Cantidad a Vender">' + '</td>' +



                        '</tr>';
                }
                $('#tbClie').html(str);

            }).fail(function (data) {
                alert("Algo salió mal" + data.error);
                var errors = data.responseJSON;

                $('.body').load('div-2.html');

            });






        function myInsertBD(array, alias) {


            $.ajax({
                type: "POST",
                url: "http://10.11.1.240:8000/api/task",
                async: true,
                dataType: "json",
                data: {
                    'array': array,
                    'alias': alias
                },//capturo array     
                success: function (response) {
                    alert("Algo salió mal" + responses);
                    console.log(response);

                },
            }).done(
                function (data, textStatus, jqXHR) {
                    alert("Algo salió mal" + responses);

                }).fail(function (data) {
                    alert("Algo salió mal" + data.error);
                    var errors = data.responseJSON;

                });
        }

        $(document).ready(function () {
            $("#tableArt").css("display", "none");
            $('#tableDet').hide();

            $.ajax({
                type: "GET",
                url: "http://10.11.1.240:8000/api/getClientByUser",
                async: true,
                dataType: "json",
                success: function (response) {
                    console.log(response);
                },
            }).done(
                function (data, textStatus, jqXHR) {
                    $('#tableArt').show();
                    var str = '';
                    for (var i = 0; i < data.length; i++) {

                        str += '<tr>' +
                            '<td>' + data[i].usr_name + '</td>' +
                            '<td>' + data[i].usr_alias + '</td>' +
                            '<td>' + data[i].usr_firstname + '</td>' +
                            '<td>' + data[i].usr_lastname + '</td>' +
                            '<td>' + data[i].det_ad_add + '</td>' +
                            '</tr>';
                    }
                    $('#tbArt').html(str);

                }).fail(function (data) {
                    alert("Algo salió mal" + data.error);
                    var errors = data.responseJSON;

                });



            $("#divVentas").click(function () {
                $('#body').load('d.html');
            });

            $("#btnEnviar").click(function () {
                var myString = "";
                var aux2, total = 0;
                arr1 = [];
                var myAux = 0;
                var str = '';
                $('.selected').each(function () {
                    str += '<tr>' +
                        '<td>' + $(this).find("td").eq(0).html() + '</td>' +
                        '<td>' + $(this).find("td").eq(3).html() + '</td>' +
                        '<td>' + $(this).find("td").find("input[name='tbCant']").val() + '</td>' +
                        '<td>' + $(this).find("td").eq(3).html() * $(this).find("td").find("input[name='tbCant']").val() + '</td>' +
                        '<td><button class="btn btn-danger btnborrar">borrar</button></td>' +
                        '</tr>';
                    // alert("Handler for .click() called." + $(this).find("td").eq(2).html() );
                    myAux++;

                    total = total + $(this).find("td").eq(3).html() * $(this).find("td").find("input[name='tbCant']").val()
                });

                 

                $('#tbDet').html(str);
                $("tfoot").remove();
                str = '<tfoot> <tr>' +
                    '<td COLSPAN="3"> TOTAL A PAGAR </td>' +
                    '<td COLSPAN="3" id = "tdTotal">' + total + '</td>' +
                    '</tr> </tfoot>';
                    $('#tableDet').append(str);

                calcular();
                $('#tableDet').show();
                console.log(typeof (arr1));

            })

        });
        $(document).on('click', '.btnborrar', function (event) {
            event.preventDefault();
            $(this).closest('tr').remove();
            calcular();
        });


        function calcular(){
           
            var aux2, total = 0;
            var str;
            $('#tbDet tr').each(function () {
                console.log( "Hola ");
                total = total + $(this).find("td").eq(1).html() * $(this).find("td").eq(2).html()

            });

           alert(total);
          $("#tdTotal").text(total);

          if(total == 0){
            $('#tableDet').hide();

          }
               


        }


        $("#btnAceptar").click(function () {

            var myString;
            arr1 = [];
            var myAux = 0;
            $('.selected').each(function () {

                arr1[myAux] = $(this).find("td").eq(0).html();

                myAux++;
            });

            myInsertBD(arr1, $("#tbUsrAlias").val());

        });



    </script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">API SERVIACERO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a id="divVentas" class="nav-link active" aria-current="page" href="">Ventas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Reporte de ventas</a>
                    </li>




            </div>
        </div>
    </nav>
    <br>
    <div class="container">
        <form class="row g-3">
            <div class="col-6">
                <label for="inputAddress" class="form-label">Display</label>
                <input type="text" class="form-control" id="tbName" placeholder="1234 Main St">
            </div>
            <div class="col-6">
                <label for="inputAddress" class="form-label">Apellido</label>
                <input type="text" class="form-control" id="tbLastName" placeholder="1234 Main St">
            </div>
            <div class="col-3">
                <label for="inputAddress" class="form-label">Shor Alias</label>
                <input type="text" class="form-control" id="tbShortAlias" placeholder="1234 Main St">
            </div>
            <div class="col-3">
                <label for="inputAddress" class="form-label">Alias Confiable</label>
                <input type="text" class="form-control" id="tbUsrAlias" placeholder="1234 Main St">
            </div>
            <div class="col-3">
                <label for="inputAddress" class="form-label">Cliente</label>
                <input type="text" class="form-control" id="tbCliente" placeholder="1234 Main St">
            </div>
            <div class="col-2">
                <label for="inputAddress" class="form-label">Agregar articulos</label>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">
                    Añadir Articulos
                </button>
            </div>
            <div class="col-3">
                <label for="inputAddress" class="form-label">Total a Pagar</label>
                <table id="tableDet" class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>PRECIO</th>

                            <th>CANTIDAD</th>

                            <th>SUBTOTAL</th>
                            <th>ELIMINAR</th>


                        </tr>
                        <tr>
                            <td class="col-3"></td>
                        </tr>
                    </thead>
                    <tbody id="tbDet">

                    </tbody>

                </table>
            </div>
            <div class="col-12">
                <button id="btnAceptar" type="submit" class="btn btn-primary">Aceptar</button>
            </div>
            </ul>



        </form>
    </div>
    </br>
    <div class="container ">


        <center>
            <div id="loading" class="container">
                <img src="mario.gif" />
                <p>Obteniendo datos...</p>
            </div>
        </center>


        <table id="tableArt" class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>Display</th>
                    <th>Alias Confiable</th>
                    <th>Nombre </th>
                    <th>Apellido</th>
                    <th>Cliente</th>

                </tr>
            </thead>
            <tbody id="tbArt">

            </tbody>

        </table>
    </div>
    </div>


    <!-- The Modal -->
    <div class="modal fade " id="myModal">
        <div class="modal-dialog  modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Asignar Cliente a usuarios</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">

                    <table id="tableClient" class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Articulo</th>
                                <th>Descripción</th>
                                <th>UM </th>
                                <th>PRECIO</th>
                                <th>Cantidad</th>

                            </tr>
                        </thead>
                        <tbody id="tbClie">

                        </tbody>

                    </table>
                </div>

                <div class="modal-footer">
                    <button id="btnEnviar" type="button" class="btn btn-outline-success"
                        data-bs-dismiss="modal">Agregar</button>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

</body>

</html>